

<!doctype html>
<html lang="pt" class="no-js">
  <head>
    

<meta charset="utf-8">



<!-- begin SEO -->









<title>Deploy do aegir com ansible: entregue instâncias Drupal na sua instituição - Thiago Gomes Veríssimo</title>







<meta property="og:locale" content="pt-BR">
<meta property="og:site_name" content="Thiago Gomes Veríssimo">
<meta property="og:title" content="Deploy do aegir com ansible: entregue instâncias Drupal na sua instituição">


  <link rel="canonical" href="https://thiagogomesverissimo.github.io/posts/deploy-aegir-com-ansible">
  <meta property="og:url" content="https://thiagogomesverissimo.github.io/posts/deploy-aegir-com-ansible">



  <meta property="og:description" content="Na última década explodiram as opções de ferramentas para publicação de conteúdos na web,em especial, os que permitiam a criação e manutenção rápida de pequenos sites ou portais institucionais.Os Sistema de Gerenciamento de Conteúdo (ou Content Management System – CMS) foram protagonistasneste cenário e três deles fizeram e fazem muito sucesso até hoje: Drupal, Joomla e Wordpress.">





  

  





  <meta property="og:type" content="article">
  <meta property="article:published_time" content="2019-03-21T00:00:00-03:00">








  <script type="application/ld+json">
    {
      "@context" : "http://schema.org",
      "@type" : "Person",
      "name" : "Thiago Gomes Verissimo",
      "url" : "https://thiagogomesverissimo.github.io",
      "sameAs" : null
    }
  </script>






<!-- end SEO -->


<link href="https://thiagogomesverissimo.github.io/feed.xml" type="application/atom+xml" rel="alternate" title="Thiago Gomes Veríssimo Feed">

<!-- http://t.co/dKP3o1e -->
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script>
  document.documentElement.className = document.documentElement.className.replace(/\bno-js\b/g, '') + ' js ';
</script>

<!-- For all browsers -->
<link rel="stylesheet" href="https://thiagogomesverissimo.github.io/assets/css/main.css">

<meta http-equiv="cleartype" content="on">
    

<!-- start custom head snippets -->

<link rel="apple-touch-icon" sizes="57x57" href="https://thiagogomesverissimo.github.io/images/apple-touch-icon-57x57.png?v=M44lzPylqQ">
<link rel="apple-touch-icon" sizes="60x60" href="https://thiagogomesverissimo.github.io/images/apple-touch-icon-60x60.png?v=M44lzPylqQ">
<link rel="apple-touch-icon" sizes="72x72" href="https://thiagogomesverissimo.github.io/images/apple-touch-icon-72x72.png?v=M44lzPylqQ">
<link rel="apple-touch-icon" sizes="76x76" href="https://thiagogomesverissimo.github.io/images/apple-touch-icon-76x76.png?v=M44lzPylqQ">
<link rel="apple-touch-icon" sizes="114x114" href="https://thiagogomesverissimo.github.io/images/apple-touch-icon-114x114.png?v=M44lzPylqQ">
<link rel="apple-touch-icon" sizes="120x120" href="https://thiagogomesverissimo.github.io/images/apple-touch-icon-120x120.png?v=M44lzPylqQ">
<link rel="apple-touch-icon" sizes="144x144" href="https://thiagogomesverissimo.github.io/images/apple-touch-icon-144x144.png?v=M44lzPylqQ">
<link rel="apple-touch-icon" sizes="152x152" href="https://thiagogomesverissimo.github.io/images/apple-touch-icon-152x152.png?v=M44lzPylqQ">
<link rel="apple-touch-icon" sizes="180x180" href="https://thiagogomesverissimo.github.io/images/apple-touch-icon-180x180.png?v=M44lzPylqQ">
<link rel="icon" type="image/png" href="https://thiagogomesverissimo.github.io/images/favicon-32x32.png?v=M44lzPylqQ" sizes="32x32">
<link rel="icon" type="image/png" href="https://thiagogomesverissimo.github.io/images/android-chrome-192x192.png?v=M44lzPylqQ" sizes="192x192">
<link rel="icon" type="image/png" href="https://thiagogomesverissimo.github.io/images/favicon-96x96.png?v=M44lzPylqQ" sizes="96x96">
<link rel="icon" type="image/png" href="https://thiagogomesverissimo.github.io/images/favicon-16x16.png?v=M44lzPylqQ" sizes="16x16">
<link rel="manifest" href="https://thiagogomesverissimo.github.io/images/manifest.json?v=M44lzPylqQ">
<link rel="mask-icon" href="https://thiagogomesverissimo.github.io/images/safari-pinned-tab.svg?v=M44lzPylqQ" color="#000000">
<link rel="shortcut icon" href="/images/favicon.ico?v=M44lzPylqQ">
<meta name="msapplication-TileColor" content="#000000">
<meta name="msapplication-TileImage" content="https://thiagogomesverissimo.github.io/images/mstile-144x144.png?v=M44lzPylqQ">
<meta name="msapplication-config" content="https://thiagogomesverissimo.github.io/images/browserconfig.xml?v=M44lzPylqQ">
<meta name="theme-color" content="#ffffff">
<link rel="stylesheet" href="https://thiagogomesverissimo.github.io/assets/css/academicons.css"/>
<link rel="stylesheet" href="https://thiagogomesverissimo.github.io/assets/css/pygments/zenburn.css"/>
<link rel="stylesheet" href="https://thiagogomesverissimo.github.io/assets/css/custom.css"/>

<script type="text/x-mathjax-config"> MathJax.Hub.Config({ TeX: { equationNumbers: { autoNumber: "all" } } }); </script>
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    tex2jax: {
      inlineMath: [ ['$','$'], ["\\(","\\)"] ],
      processEscapes: true
    }
  });
</script>
<script src='https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.4/latest.js?config=TeX-MML-AM_CHTML' async></script>

<!-- end custom head snippets -->

  </head>

  <body>

    <!--[if lt IE 9]>
<div class="notice--danger align-center" style="margin: 0;">You are using an <strong>outdated</strong> browser. Please <a href="http://browsehappy.com/">upgrade your browser</a> to improve your experience.</div>
<![endif]-->
    

<div class="masthead">
  <div class="masthead__inner-wrap">
    <div class="masthead__menu">
      <nav id="site-nav" class="greedy-nav">
        <button><div class="navicon"></div></button>
        <ul class="visible-links">
          <li class="masthead__menu-item masthead__menu-item--lg"><a href="https://thiagogomesverissimo.github.io/">Thiago Gomes Veríssimo</a></li>
          
            
            <li class="masthead__menu-item"><a href="https://thiagogomesverissimo.github.io/">Posts</a></li>
          
            
            <li class="masthead__menu-item"><a href="https://thiagogomesverissimo.github.io/curriculo/">Currículo</a></li>
          
        </ul>
        <ul class="hidden-links hidden"></ul>
      </nav>
    </div>
  </div>
</div>

    




  
    





<nav class="breadcrumbs">
  <ol itemscope itemtype="http://schema.org/BreadcrumbList">
    
    
    
      
        <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
          <a href="https://thiagogomesverissimo.github.io/" itemprop="item"><span itemprop="name">Início</span></a>
          <meta itemprop="position" content="1" />
        </li>
        <span class="sep">/</span>
      
      
        
        <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
          <a href="https://thiagogomesverissimo.github.ioposts" itemprop="item"><span itemprop="name">Posts</span></a>
          <meta itemprop="position" content="2" />
        </li>
        <span class="sep">/</span>
      
    
      
      
        <li class="current">Deploy do aegir com ansible: entregue instâncias Drupal na sua instituição</li>
      
    
  </ol>
</nav>
  


<div id="main" role="main">
  


  <div class="sidebar sticky">
  



<div itemscope itemtype="http://schema.org/Person">

  <div class="author__avatar">
    
    	<img src="https://thiagogomesverissimo.github.io/images/thiago.jpg" class="author__avatar" alt="Thiago Gomes Verissimo">
    
  </div>

  <div class="author__content">
    <h3 class="author__name">Thiago Gomes Verissimo</h3>
    <p class="author__bio"></p>
  </div>

  <div class="author__urls-wrapper">
    <button class="btn btn--inverse">Follow</button>
    <ul class="author__urls social-icons">
      
      
      
      
        <li><a href="mailto:verissimotgv@gmail.com"><i class="fas fa-fw fa-envelope" aria-hidden="true"></i> E-mail</a></li>
      
      <li><a href="https://www.drupal.org/u/thiagogomesverissimo"><i class="fab fa-fw fa-drupal" aria-hidden="true"></i> Drupal</a></li>
      

      
      <li><a href="https://github.com/thiagogomesverissimo"><i class="fab fa-fw fa-github" aria-hidden="true"></i> Github</a></li>
      
      
      <li><a href="https://gitlab.com/thiagogomesverissimo"><i class="fab fa-fw fa-gitlab" aria-hidden="true"></i> Gitlab</a></li>
      
      
      <li><a href="https://bitbucket.org/thiagogomesverissimo"><i class="fab fa-fw fa-bitbucket" aria-hidden="true"></i> Bitbucket</a></li>
      

      

      
        <li><a href="https://orcid.org/0000-0001-6117-3616"><i class="ai ai-orcid-square ai-fw"></i> ORCID</a></li>
      
      
      <li><a href="https://scholar.google.com/citations?user=HWMEGlYAAAAJ"><i class="ai ai-google-scholar-square ai-fw"></i> Google Scholar</a></li>
      
      <li><a href="http://lattes.cnpq.br/7983798047288613"><i class="ai ai-lattes-square ai-fw"></i> Lattes</a></li>

      
        <li><a href="https://www.linkedin.com/in/thiagogomesveríssimo"><i class="fab fa-fw fa-linkedin" aria-hidden="true"></i> LinkedIn</a></li>
      
      
      
        <li><a href="https://www.researchgate.net/profile/Thiago_Gomes_Verissimo/"><i class="fab fa-fw fa-researchgate" aria-hidden="true"></i> ResearchGate</a></li>
      
      
        <li><a href="https://twitter.com/thigove"><i class="fab fa-fw fa-twitter-square" aria-hidden="true"></i> Twitter</a></li>
      
      
        <li><a href="https://www.facebook.com/thiagogomesverissimo"><i class="fab fa-fw fa-facebook-square" aria-hidden="true"></i> Facebook</a></li>
      
      

      
      
        <li><a href="https://instagram.com/thiagogomesverissimo"><i class="fab fa-fw fa-instagram" aria-hidden="true"></i> Instagram</a></li>
      
      
      
        <li><a href="https://www.stackoverflow.com/users/11781341/thiagogomesverissimo"><i class="fab fa-fw fa-stack-overflow" aria-hidden="true"></i> Stackoverflow</a></li>
      

      
      
      
      
      
      
      
      
      
      
      
      
      
      

      <li><a href="https://thiagogomesverissimo.github.io/files/keys/id_rsa.pub"><i class="fa fa-fw fa-terminal" aria-hidden="true"></i> ssh public key</a></li>
      <li><a href="https://thiagogomesverissimo.github.io/files/keys/AAA3BE9F.public.asc"><i class="fa fa-fw fa-user-secret" aria-hidden="true"></i> gpg public key</a></li>
      
    </ul>
  </div>
</div>

  
  </div>


  <article class="page" itemscope itemtype="http://schema.org/CreativeWork">
    
    <meta itemprop="description" content="Na última década explodiram as opções de ferramentas para publicação de conteúdos na web,em especial, os que permitiam a criação e manutenção rápida de pequenos sites ou portais institucionais.Os Sistema de Gerenciamento de Conteúdo (ou Content Management System – CMS) foram protagonistasneste cenário e três deles fizeram e fazem muito sucesso até hoje: Drupal, Joomla e Wordpress.">
    <meta itemprop="datePublished" content="March 21, 2019">
    
    <meta itemprop="headline" content="Deploy do aegir com ansible: entregue instâncias Drupal na sua instituição">

    <div class="page__inner-wrap">
      
        <header>
          
          
        
          <p class="page__date"><strong><i class="fa fa-fw fa-calendar" aria-hidden="true"></i> Atualizado em:</strong> <time datetime="2019-03-21T00:00:00-03:00">21/03/2019</time></p>
         
        <br>
        <h1 class="page__title" itemprop="headline"><a href="">Deploy do aegir com ansible: entregue instâncias Drupal na sua instituição
 </a><a href="" rel="permalink"><i class="fa fa-link" aria-hidden="true" title="permalink"></i><span class="sr-only">Permalink</span></a></h1>
             
        
    
        </header>
      

      <section class="page__content" itemprop="text">
        <p>Na última década explodiram as opções de ferramentas para publicação de conteúdos na web,
em especial, os que permitiam a criação e manutenção rápida de pequenos sites ou portais institucionais.
Os Sistema de Gerenciamento de Conteúdo (ou Content Management System – CMS) foram protagonistas
neste cenário e três deles fizeram e fazem muito sucesso até hoje: Drupal, Joomla e Wordpress.</p>

<p>Nos três CMS’s a curva de aprendizado inicial é baixa e o tempo despendido desde a instalação
até a configuração mínima para colocarmos um site no ar é pequeno, sendo assim, comum
encontrar pessoas que conseguem publicar seus conteúdos na web, mesmo sem conhecimento
profundo de infraestrutura ou desenvolvimento.
No geral, usam hospedagens compartilhadas e naturalmente depois que o site está no ar, deixam de 
dar atenção as questões técnicas, como aplicação de atualizações de seguranças recomendadas
(que chegam a ser semanais) e passam a se dedicar mais aos conteúdos, cenário que eventualmente
propicia aumento das chances desses sites serem atacados.</p>

<p>Em grandes instituições e em especial as geograficamente distribuídas, como nos órgãos do governo, 
os sites de setores internos podem ou não compartilhar algumas características, 
sendo que um sistema que permite o gerenciamento de múltiplas instâncias de sites no mesmo código 
é mais vantajoso que o modelo de hospedagem compartilhada, pois torna mais eficiente a 
manutenção por parte da equipe de infraestrutura.</p>

<p>Neste texto, vamos abordar esse cenário com Drupal dando um foco na perspectiva de quem
gerencia a infraestrutura. O Drupal implementa nativamente uma estrutura chamada multisite,
que permite entregarmos instâncias de sites independentes no conteúdo, mas rodando no mesmo 
core.
O <a href="https://www.aegirproject.org/">aegir</a> é um software desenvolvido em drupal que nos permite 
gerenciar de forma fácil outras instâncias Drupal usando o próprio conceito de multisites, 
sendo que administração dessas instâncias pode ser feita via terminal ou pela web.</p>

<h2 id="criando-um-ambiente-básico-de-desenvolvimento">Criando um ambiente básico de desenvolvimento</h2>

<p>Para seguir esse tutorial uso-se no ambiente de desenvolvimento a dupla
virualbox e  vagrant. Não é obrigatório usá-los, mas disponibilizo o
Vagrantfile da máquina virtual (VM) com a parametrização mínima para instalação
do aegir usando Debian:</p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="no">Vagrant</span><span class="p">.</span><span class="nf">configure</span><span class="p">(</span><span class="s2">"2"</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">config</span><span class="o">|</span>
  <span class="n">config</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">define</span> <span class="s2">"aegir"</span> <span class="k">do</span> <span class="o">|</span><span class="n">host</span><span class="o">|</span> 
    <span class="n">host</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">box</span> <span class="o">=</span> <span class="s2">"debian/buster64"</span>
    <span class="n">host</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">network</span> <span class="ss">:private_network</span><span class="p">,</span> <span class="ss">ip: </span><span class="s2">"192.168.8.8"</span>
    <span class="n">config</span><span class="p">.</span><span class="nf">ssh</span><span class="p">.</span><span class="nf">insert_key</span> <span class="o">=</span> <span class="kp">false</span>
    <span class="n">host</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">provider</span> <span class="ss">:virtualbox</span> <span class="k">do</span> <span class="o">|</span><span class="n">v</span><span class="o">|</span>
      <span class="n">v</span><span class="p">.</span><span class="nf">name</span> <span class="o">=</span> <span class="s2">"aegir"</span>
      <span class="n">v</span><span class="p">.</span><span class="nf">memory</span> <span class="o">=</span> <span class="mi">512</span>
      <span class="n">v</span><span class="p">.</span><span class="nf">cpus</span> <span class="o">=</span> <span class="mi">1</span>
      <span class="n">v</span><span class="p">.</span><span class="nf">customize</span> <span class="p">[</span><span class="s2">"modifyvm"</span><span class="p">,</span> <span class="ss">:id</span><span class="p">,</span> <span class="s2">"--natdnshostresolver1"</span><span class="p">,</span> <span class="s2">"on"</span><span class="p">]</span>
      <span class="n">v</span><span class="p">.</span><span class="nf">customize</span> <span class="p">[</span><span class="s2">"modifyvm"</span><span class="p">,</span> <span class="ss">:id</span><span class="p">,</span> <span class="s2">"--ioapic"</span><span class="p">,</span> <span class="s2">"on"</span><span class="p">]</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre></figure>

<p>Crie um diretório e salve esse código em um arquivo chamado Vagrantfile.
Com o comando <em>vagrant up</em> criaremos a VM e com <em>vagrant ssh</em> conectaremos 
na máquina via ssh.</p>

<figure class="highlight"><pre><code class="language-shell" data-lang="shell"><span class="nv">$ </span>mkdir aegir-tutorial
<span class="nv">$ </span><span class="nb">cd </span>aegir-tutorial
<span class="nv">$ </span>touch Vagrantfile <span class="c"># inserir conteúdo do Vagrantfile acima</span>
<span class="nv">$ </span>vagrant up
<span class="nv">$ </span>vagrant ssh</code></pre></figure>

<p>Nossa VM vai subir com IP 192.168.8.8, que pode ser alterado no Vagrantfile.
O sistema de multisite do Drupal exige que cada site tenha seu próprio domínio,
mas para finalidade desse tutorial, algumas entradas em <em>/etc/hosts</em> na nossa 
máquina física (hospedeira) são suficiente:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="c"># Algumas entradas em /etc/hosts</span>
192.168.8.8 aegir.xurepinha.net aegir
192.168.8.8 site1.xurepinha.net site1
192.168.8.8 site2.xurepinha.net site2
192.168.8.8 site3.xurepinha.net site3</code></pre></figure>

<h2 id="aegir">Aegir</h2>

<p>Há duas formas de instalação do aegir: manual ou usando um repositório.
No <a href="https://www.aegirproject.org/#download">site oficial do aegir</a>
há informações de como adicionar o repositório que permite então 
instalarmos o aegir usando o apt:</p>

<figure class="highlight"><pre><code class="language-console" data-lang="console"><span class="gp">#</span> apt-get install aegir3 aegir-archive-keyring</code></pre></figure>

<p>No processo de instalação, quando for perguntado qual a <em>URL of the hostmaster
frontend</em> coloque uma das urls que registramos em <em>/etc/hosts</em>,como por exemplo: 
<em>aegir.xurepinha.net</em>. Depois de instalado, pode-se trocar a senha
do usuário admin (criado pelo aegir) usando drush:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nb">sudo </span>su aegir
drush @hostmaster user-password admin <span class="nt">--password</span><span class="o">=</span><span class="s1">'admin'</span></code></pre></figure>

<p>No seu navegador acesse <em>http://aegir.xurepinha.net</em> com usuário e senha
admin.</p>

<p>O aegir trabalha com o conceito de plataforma, que nada mais é
que o core do drupal em conjunto com os módulos, profiles, temas e bibliotecas.
Os sites rodam em cima das plataformas, e o servidor aegir nos permite
gerenciar múltiplas plataformas e portanto conseguimos gerenciar no mesmo 
ambiente diferentes versões de drupal.
Para tal, baixe as versões do drupal que irá trabalhar na pasta
<em>/var/aegir/platforms/</em> manualmente ou com drush. Pela interface,
vá na opção criar plataforma, coloque o caminho do drupal baixado,
como por exemplo <em>/var/aegir/platforms/drupal-8.6.1</em> e voilà! 
Adicione sites na plataforma recém criada depois módulos, temas etc.</p>

<p>A versão empacotada do aegir instala versões do php, apache2 e drush
e outras dependências. Na instalação manual descrita no 
<a href="https://docs.aegirproject.org/install/">site oficial</a>
temos mais controle das versões das dependências, o que é muito mais prático na era
do Drupal 8 onde exige-se cada vez mais versões mais recentes do php.
Os passos na instalação manual são muitos e é importante fazê-los ao menos uma vez. 
Uma vez que a instalação manual é dominada, podemos automatizá-la
usando ferramentas que executam tarefas em um servidor, processo chamado 
de provisionamento. Vamos usar o ansible para esta finalidade.</p>

<h2 id="instalação-do-aegir-usando-ansible">Instalação do aegir usando ansible</h2>

<p>Vamos deletar nosso ambiente e recriá-lo usando ansible.
Remova a VM criada anteriormente e crie-a novamente.
Se estiver usando vagrant, esses sãos os comandos:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">vagrant destroy <span class="nt">-f</span>
vagrant up</code></pre></figure>

<p>Instale o ansible na sua máquina hospedeira como indicado na
documentação <a href="https://ansible.com">oficial</a>.
Vamos criar os arquivos mínimos que nos permitirão provisionar 
o aegir com o ansible:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$ </span>touch hosts ansible.cfg playbook.yml</code></pre></figure>

<p>Conteúdo do arquivo <em>ansible.cfg</em>:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="o">[</span>defaults]
allow_world_readable_tmpfiles <span class="o">=</span> True
inventory <span class="o">=</span> ./hosts
roles_path <span class="o">=</span> ./roles</code></pre></figure>

<p>Conteúdo do arquivo <em>hosts</em>:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="o">[</span>aegir]
192.168.8.8 
<span class="o">[</span>aegir:vars]
<span class="nv">ansible_connection</span><span class="o">=</span>ssh
<span class="nv">ansible_user</span><span class="o">=</span>vagrant
<span class="nv">ansible_ssh_private_key_file</span><span class="o">=</span><span class="s2">"~/.vagrant.d/insecure_private_key"</span></code></pre></figure>

<p>No ansible, colocamos a receita para construção do nosso servidor em um playbook.
Podemos especificar tarefa por tarefa no playbook do que deve ser feito ou podemos
agrupar, idealmente semanticamente, essa tarefas em uma role e chamar essa role
a partir do playbook.</p>

<p>Assim, uma role passa a ser simplesmente um agrupamento de tarefas, no intuito
de encapsular um procedimento de instalação e/ou configuração de algum software.</p>

<p>Existem muitas roles espalhadas pela web que fazem <em>N</em> coisas e 
antes de desenvolver a sua própria é sempre bom procurar para verificar
se não tem alguma role que faça exatamente o que você quer ou pelo menos
que seja ponto de partida para alcançar seu objetivo.</p>

<p>Vamos usar algumas roles famosas e delegar a instalação de dependências 
mínimas para nosso servidor aegir.
Começando pelo apache, vamos baixar a role geerlingguy.apache 
usando o comando ansible-galaxy:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$ </span>mkdir roles
<span class="nv">$ </span>ansible-galaxy install geerlingguy.apache</code></pre></figure>

<p>Agora criaremos nosso playbook e instalaremos o apache
no nosso servidor. 
Crie um arquivo playbook.yml e coloque o seguinte conteúdo:</p>

<figure class="highlight"><pre><code class="language-yml" data-lang="yml"><span class="nn">---</span>
<span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">playbook que instala um servidor aegir</span>
  <span class="na">become</span><span class="pi">:</span> <span class="s">yes</span>
  <span class="na">hosts</span><span class="pi">:</span> <span class="s">aegir</span>
  <span class="na">roles</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s">geerlingguy.apache</span></code></pre></figure>

<p>E para rodar o playbook e fazer o provisionamento do servidor:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$ </span>ansible-playbook playbook.yml</code></pre></figure>

<p>A próxima role que vamos adicionar permite que nosso servidor trabalhe
com múltiplas versões do php:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$ </span>ansible-galaxy install geerlingguy.php-versions</code></pre></figure>

<p>Na role anterior, apenas instalamos o apache com as configurações
defaults definidas pela role, que podem ser conferidas nas variáveis
definidas em defaults/main.yml.
Na role php-versions, vamos sobrescrever as configurações defaults, pois queremos escolher 
a versão do php como 7.2. Assim, configuraremos uma variável que específica
a versão do php, no caso, php_version, como definido em defaults/main.yml:</p>

<figure class="highlight"><pre><code class="language-yml" data-lang="yml"><span class="nn">---</span>
<span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">playbook que instala um servidor aegir</span>
  <span class="na">become</span><span class="pi">:</span> <span class="s">yes</span>
  <span class="na">hosts</span><span class="pi">:</span> <span class="s">aegir</span>
  <span class="na">vars</span><span class="pi">:</span>
    <span class="c1"># geerlingguy.php-versions</span>
    <span class="na">php_version</span><span class="pi">:</span> <span class="s1">'</span><span class="s">7.2'</span>
  <span class="na">roles</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s">geerlingguy.apache</span>
    <span class="pi">-</span> <span class="s">geerlingguy.php-versions</span></code></pre></figure>

<p>A role <em>geerlingguy.php</em> instala de fato o php e em conjunto
vamos baixar a role <em>geerlingguy.composer</em> para também instalar
composer na sequência, por sinal, o ansible irá executar as roles
na sequência que elas são declaradas no playbook.</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$ </span>ansible-galaxy install geerlingguy.php geerlingguy.composer</code></pre></figure>

<p>E novamente vamos controlar o que a role <em>php</em> deve 
ou não fazer sobrescrevendo variáveis defaults. Para 
a role composer não vamos alterar nada.</p>

<figure class="highlight"><pre><code class="language-yml" data-lang="yml"><span class="nn">---</span>
<span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">playbook que instala um servidor aegir</span>
  <span class="na">become</span><span class="pi">:</span> <span class="s">yes</span>
  <span class="na">hosts</span><span class="pi">:</span> <span class="s">aegir</span>
  <span class="na">vars</span><span class="pi">:</span>
    <span class="c1"># geerlingguy.php-versions</span>
    <span class="na">php_version</span><span class="pi">:</span> <span class="s1">'</span><span class="s">7.2'</span>
    <span class="c1"># geerlingguy.php</span>
    <span class="na">php_default_version_debian</span><span class="pi">:</span> <span class="s1">'</span><span class="s">7.2'</span>
    <span class="na">php_use_managed_ini</span><span class="pi">:</span> <span class="no">false</span>
    <span class="na">php_packages_extra</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">php-mysql</span>
  <span class="na">roles</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s">geerlingguy.apache</span>
    <span class="pi">-</span> <span class="s">geerlingguy.php-versions</span>
    <span class="pi">-</span> <span class="s">geerlingguy.php</span>
    <span class="pi">-</span> <span class="s">geerlingguy.composer</span></code></pre></figure>

<p>Até o momento o aegir só suporta mysql e usaremos 
a role <em>geerlingguy.mysql</em>.
É uma prática provisionar esse servidor mysql em outro servidor,
assim faríamos um outro playbook,
mas por questão de praticade, vamos usar o mesmo playbook e portanto
mesmo servidor.</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$ </span>ansible-galaxy install geerlingguy.mysql</code></pre></figure>

<p>Vamos criar um superusário do mysql chamado <em>aegir_root</em> 
que será usado pelo aegir para gerenciar
os bancos de dados das instâncias dos sites entregues por ele.</p>

<figure class="highlight"><pre><code class="language-yml" data-lang="yml"><span class="nn">---</span>
<span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">playbook que instala um servidor aegir</span>
  <span class="na">become</span><span class="pi">:</span> <span class="s">yes</span>
  <span class="na">hosts</span><span class="pi">:</span> <span class="s">aegir</span>
  <span class="na">vars</span><span class="pi">:</span>
    <span class="c1"># geerlingguy.php-versions</span>
    <span class="na">php_version</span><span class="pi">:</span> <span class="s1">'</span><span class="s">7.2'</span>
    <span class="c1"># geerlingguy.php</span>
    <span class="na">php_default_version_debian</span><span class="pi">:</span> <span class="s1">'</span><span class="s">7.2'</span>
    <span class="na">php_use_managed_ini</span><span class="pi">:</span> <span class="no">false</span>
    <span class="na">php_packages_extra</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">php-mysql</span>
    <span class="c1"># geerlingguy.mysql</span>
    <span class="na">mysql_users</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">aegir_root</span>
        <span class="na">host</span><span class="pi">:</span> <span class="s2">"</span><span class="s">localhost"</span>
        <span class="na">password</span><span class="pi">:</span> <span class="s2">"</span><span class="s">aegir_root"</span>
        <span class="na">priv</span><span class="pi">:</span> <span class="s2">"</span><span class="s">*.*:ALL,GRANT"</span>
  <span class="na">roles</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s">geerlingguy.apache</span>
    <span class="pi">-</span> <span class="s">geerlingguy.php-versions</span>
    <span class="pi">-</span> <span class="s">geerlingguy.php</span>
    <span class="pi">-</span> <span class="s">geerlingguy.composer</span>
    <span class="pi">-</span> <span class="s">geerlingguy.mysql</span></code></pre></figure>

<p>Neste estágio, nosso servidor está completamente preparado
para a instalação do aegir. Dependendo do seu cenário, talvez
você queira escrever uma role para fazer a configuração e
instalação do aegir.</p>

<p>Quando trabalhamos com ansible é muito provável
que você encontre roles que implementam parte daquilo
que precisamos, no caso do aegir, 
<a href="https://github.com/GetValkyrie/">@GetValkyrie</a>
implementou uma <a href="https://github.com/GetValkyrie/ansible-role-aegir">role</a>
que instala e configura o aegir, mas não é atualizada desde 2015.
Olhei os muitos forks que existem dessa role e o mantido pelo
<a href="https://github.com/ergonlogic">ergonlogic</a>,
no meu ponto de vista mantém a <a href="https://github.com/ergonlogic/ansible-role-aegir">role</a> 
mais completa para o aegir.</p>

<p>Um passo adicional que essa role não faz, por enquanto,
é a criação automática de plataformas a partir de projetos
drupal 8 baseados em composer e versionados com git. Assim, criei um 
<a href="https://github.com/thiagogomesverissimo/ansible-role-aegir">fork</a>
da role do <a href="https://github.com/ergonlogic">ergonlogic</a> com essa
implementação, que vamos usar aqui.</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$ </span>ansible-galaxy install thiagogomesverissimo.aegir</code></pre></figure>

<p>Assim, finalmente chegamos ao playbook completo para 
instalação e configuração do aegir, que pode ser modificado
conforme suas necessidades e seu ambiente.</p>

<figure class="highlight"><pre><code class="language-yml" data-lang="yml"><span class="nn">---</span>
<span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">playbook que instala um servidor aegir</span>
  <span class="na">become</span><span class="pi">:</span> <span class="s">yes</span>
  <span class="na">hosts</span><span class="pi">:</span> <span class="s">aegir</span>
  <span class="na">vars</span><span class="pi">:</span>
    <span class="c1"># geerlingguy.php-versions</span>
    <span class="na">php_version</span><span class="pi">:</span> <span class="s1">'</span><span class="s">7.2'</span>
    <span class="c1"># geerlingguy.php</span>
    <span class="na">php_default_version_debian</span><span class="pi">:</span> <span class="s1">'</span><span class="s">7.2'</span>
    <span class="na">php_use_managed_ini</span><span class="pi">:</span> <span class="no">false</span>
    <span class="na">php_packages_extra</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">php-mysql</span>
    <span class="c1"># geerlingguy.mysql</span>
    <span class="na">mysql_users</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">aegir_root</span>
        <span class="na">host</span><span class="pi">:</span> <span class="s2">"</span><span class="s">%"</span>
        <span class="na">password</span><span class="pi">:</span> <span class="s2">"</span><span class="s">aegir_root"</span>
        <span class="na">priv</span><span class="pi">:</span> <span class="s2">"</span><span class="s">*.*:ALL,GRANT"</span>
    <span class="c1"># aegir</span>
    <span class="na">aegir_db_user</span><span class="pi">:</span> <span class="s1">'</span><span class="s">aegir_root'</span>
    <span class="na">aegir_db_password</span><span class="pi">:</span> <span class="s1">'</span><span class="s">aegir_root'</span>
    <span class="na">aegir_frontend_url</span><span class="pi">:</span> <span class="s1">'</span><span class="s">aegir.xurepinha.net'</span> 
    <span class="na">aegir_additional_packages</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">libapache2-mod-php</span>
    <span class="na">aegir_install_git_platforms</span><span class="pi">:</span> <span class="no">true</span>
    <span class="na">aegir_git_platforms</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">master</span>
        <span class="na">repo</span><span class="pi">:</span> <span class="s">https://github.com/fflch/drupal8.git</span>
        <span class="na">version</span><span class="pi">:</span> <span class="s">master</span>
  <span class="na">roles</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s">geerlingguy.apache</span>
    <span class="pi">-</span> <span class="s">geerlingguy.php-versions</span>
    <span class="pi">-</span> <span class="s">geerlingguy.php</span>
    <span class="pi">-</span> <span class="s">geerlingguy.composer</span>
    <span class="pi">-</span> <span class="s">geerlingguy.mysql</span>
    <span class="pi">-</span> <span class="s">thiagogomesverissimo.aegir</span></code></pre></figure>


        
      </section>

      <footer class="page__meta">
        
        


  




  
  
  

  <p class="page__taxonomy">
    <strong><i class="fa fa-fw fa-tags" aria-hidden="true"></i> Tags: </strong>
    <span itemprop="keywords">
    
      
      
      <a href="https://thiagogomesverissimo.github.io/tags/#aegir" class="page__taxonomy-item" rel="tag">aegir</a><span class="sep">, </span>
    
      
      
      <a href="https://thiagogomesverissimo.github.io/tags/#ansible" class="page__taxonomy-item" rel="tag">ansible</a>
    
    </span>
  </p>




  






  
  
  

  <p class="page__taxonomy">
    <strong><i class="fa fa-fw fa-folder-open" aria-hidden="true"></i> Categorias: </strong>
    <span itemprop="keywords">
    
      
      
      <a href="https://thiagogomesverissimo.github.io/categories/#tutorial" class="page__taxonomy-item" rel="tag">tutorial</a>
    
    </span>
  </p>


      </footer>

      

<section class="page__share">
  
    <h4 class="page__share-title">Compartilhe em</h4>
  

  <a href="https://twitter.com/intent/tweet?text=https://thiagogomesverissimo.github.io/posts/deploy-aegir-com-ansible" class="btn btn--twitter" title="Compartilhe em Twitter"><i class="fab fa-twitter" aria-hidden="true"></i><span> Twitter</span></a>

  <a href="https://www.facebook.com/sharer/sharer.php?u=https://thiagogomesverissimo.github.io/posts/deploy-aegir-com-ansible" class="btn btn--facebook" title="Compartilhe em Facebook"><i class="fab fa-facebook" aria-hidden="true"></i><span> Facebook</span></a>

  <a href="https://www.linkedin.com/shareArticle?mini=true&url=https://thiagogomesverissimo.github.io/posts/deploy-aegir-com-ansible" class="btn btn--linkedin" title="Compartilhe em LinkedIn"><i class="fab fa-linkedin" aria-hidden="true"></i><span> LinkedIn</span></a>
</section>

      


  <nav class="pagination">
    
      <a href="https://thiagogomesverissimo.github.io/posts/drush-commands" class="pagination--pager" title="Compilação de comandos drush em ambiente multisite
">Anterior</a>
    
    
      <a href="https://thiagogomesverissimo.github.io/posts/multiplos-emails" class="pagination--pager" title="Múltiplos envios de e-mails a partir de uma template
">Próxima</a>
    
  </nav>

    </div>

    
      

<div class="page__comments">
  
  
    <h4 class="page__comments-title">Deixe um comentário</h4>
    <section id="disqus_thread"></section>
  
</div>
    
  </article>

  
  
</div>


    <div class="page__footer">
      <footer>
        <!-- start custom footer snippets -->
<a href="/sitemap/">Sitemap</a>
<!-- end custom footer snippets -->


        

<div class="page__footer-follow">
  <ul class="social-icons">
    
      <li><strong>Acompanhe em</strong></li>
    
    
    
    
      <li><a href="http://github.com/thiagogomesverissimo"><i class="fab fa-github" aria-hidden="true"></i> GitHub</a></li>
    
    
      <li><a href="http://bitbucket.org/thiagogomesverissimo"><i class="fab fa-bitbucket" aria-hidden="true"></i> Bitbucket</a></li>
    
    <li><a href="https://thiagogomesverissimo.github.io/feed.xml"><i class="fa fa-fw fa-rss-square" aria-hidden="true"></i> Feed</a></li>
  </ul>
</div>

<div class="page__footer-copyright">&copy; 2020 Thiago Gomes Verissimo. Feito por <a href="http://jekyllrb.com" rel="nofollow">Jekyll</a> &amp; <a href="https://github.com/academicpages/academicpages.github.io">AcademicPages</a>, a fork of <a href="https://mademistakes.com/work/minimal-mistakes-jekyll-theme/" rel="nofollow">Minimal Mistakes</a>.</div>

      </footer>
    </div>

    <script src="https://thiagogomesverissimo.github.io/assets/js/main.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/tocbot/4.4.2/tocbot.min.js"></script>
<script src="https://thiagogomesverissimo.github.io/assets/js/custom.js"></script>




  <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-129137680-1', 'auto');
  ga('send', 'pageview');
</script>






  
  <script type="text/javascript">
  	/* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
  	var disqus_shortname = 'thiagogomesverissimo';

  	/* * * DON'T EDIT BELOW THIS LINE * * */
  	(function() {
  		var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
  		dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
  		(document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  	})();

  	/* * * DON'T EDIT BELOW THIS LINE * * */
  	(function () {
  		var s = document.createElement('script'); s.async = true;
  		s.type = 'text/javascript';
  		s.src = '//' + disqus_shortname + '.disqus.com/count.js';
  		(document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
  	}());
  </script>
  <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>






  </body>
</html>

